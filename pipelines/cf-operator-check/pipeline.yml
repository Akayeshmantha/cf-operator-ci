resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: teliaoss/github-pr-resource
- name: status
  type: docker-image
  source:
    repository: resource/github-status
    tag: release

resources:
- name: src
  type: pull-request
  tags: [containerization]
  source:
    repository: ((pr-repo))
    access_token: ((github.access-token))
- name: status
  type: status
  source:
    access_token: ((github.access-token))
    repo: ((pr-repo))
- name: ci
  type: git
  tags: [containerization]
  source:
    uri: ((ci-repo))
    branch: ((ci-branch))

jobs:
- name: vet
  serial: true
  serial_groups: [go-cache]
  plan:
  - aggregate:
    - get: ci
      trigger: true
    - get: src
      trigger: true
  - put: status
    params:
      context: vet
      description: go vet check
      path: src
      state: pending
  - do:
    - task: vet
      tags: [containerization]
      configuration: (( load "../../common/tasks/vet.yml" ))
    on_failure:
      put: status
      params:
        context: vet
        description: go vet check
        path: src
        state: failure
    on_success:
      put: status
      params:
        context: vet
        description: go vet check
        path: src
        state: success

- name: lint
  serial: true
  serial_groups: [go-cache]
  plan:
  - aggregate:
    - get: ci
      trigger: true
    - get: src
      trigger: true
  - put: status
    params:
      context: lint
      description: lint check
      path: src
      state: pending
  - do:
    - task: lint
      tags: [containerization]
      configuration: (( load "../../common/tasks/lint.yml" ))
    on_failure:
      put: status
      params:
        context: lint
        description: go lint check
        path: src
        state: failure
    on_success:
      put: status
      params:
        context: lint
        description: go lint check
        path: src
        state: success

- name: test
  serial: true
  serial_groups: [go-cache]
  plan:
  - aggregate:
    - get: ci
      trigger: true
    - get: src
      trigger: true
  - put: status
    params:
      context: test
      description: go test check
      path: src
      state: pending
  - do:
    - task: test
      tags: [containerization]
      configuration: (( load "../../common/tasks/test.yml" ))
    - task: test-integration
      tags: [containerization]
      params:
        ibmcloud_apikey: ((ibmcloud.key-value))
        ibmcloud_server: ((ibmcloud.server))
        ibmcloud_region: ((ibmcloud.region))
        ibmcloud_cluster: ((ibmcloud.cluster))
      configuration: (( load "../../common/tasks/test-integration.yml" ))
    on_failure:
      put: status
      params:
        context: test
        description: go test check
        path: src
        state: failure
    on_success:
      put: status
      params:
        context: test
        decription: go test check
        path: src
        state: success

- name: build
  serial: true
  serial_groups: [go-cache]
  plan:
  - aggregate:
    - get: ci
      trigger: true
    - get: src
      trigger: true
  - put: status
    params:
      context: build
      description: go build check
      path: src
      state: pending
  - do:
    - task: build
      tags: [containerization]
      configuration: (( load "../../common/tasks/build.yml" ))
    on_failure:
      put: status
      params:
        context: build
        description: go build check
        path: src
        state: failure
    on_success:
      put: status
      params:
        context: build
        decription: go build check
        path: src
        state: success

